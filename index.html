<html>
<head>
	<title>Remote Soundmanager2</title>
	<script type="text/javascript" src="js/json2.min.js"></script>
	<script type="text/javascript" src="js/soundmanager2.js"></script>
	<script type="text/javascript">
		var cloneObj= function(acceptor, donor, black_list, white_list){
		  //not deep! 
		  var _no = acceptor || {};
		  for (var a in donor){
		    if (!white_list || white_list.indexOf(a) > -1){
		      if (!black_list || black_list.indexOf(a) == -1){
		        _no[a] = donor[a];
		      }
		    }
		    
		  }
		  return _no;
		};
		var getUrlParameters= function(str){
			var url_vars = str.replace(/^\?/,'').split('&');
			var full_url = {};
			for (var i=0; i < url_vars.length; i++) {
				var _h = url_vars[i].split('=');
				full_url[_h[0]] = _h[1];
				if (_h[1]){
					try {
						full_url[_h[0]] = JSON.parse(_h[1]);
					} catch (e){}
				}
				
			};
			return full_url;
		};


		var sm2,
			iframed = window.parent != window;

		var sendMsg = function(name, param){
			if (typeof param == 'undefined'){
				param = ''
			} else{
				param =  ": " + (param === Object(param) ? JSON.stringify(param) : !!param);
			}
			

			if (iframed){
				window.parent.postMessage("" + name + param, "*");
			}
		};

		var sm2Loaded = function(soundManager){
			if (soundManager){
				sm2 = soundManager;
			}
			sendMsg('sm2loaded', !!soundManager);

		};

		var soundSample = {
			onplay: function(){
				sendMsg('play', {id: this.id})
			},
			onresume: function(){
				sendMsg('play', {id: this.id})
			},
			onpause: function(){
				sendMsg('pause', {id: this.id})
			},
			onstop: function(){
				sendMsg('stop', {id: this.id})
			},
			onfinish: function(){
				sendMsg('finish', {id: this.id})
			},
			whileplaying: function(){
				sendMsg('playing', {
					id: this.id
				});
			},
			whileloading: function(){
				sendMsg('loading', {
					id: this.id
				});
			},
			ondataerror: function(){
				sendMsg('error', {
					id: this.id
				});
			}
		};
		
		var plc = {
			create: function(s, opts){
				if (!s || s.url != opts.url){
					if (s){
						s.destroySound()
					}
					var sound_options = cloneObj({}, soundSample);
					sound_options.id = opts.id;
					sound_options.url = opts.url;

					if (opts.volume){
						sound_options.volume = parseFloat(opts.volume);
					}
					sm2.createSound(sound_options);
				}
			},
			play: function(s){
				s.play();
			},
			stop: function(s){
				if (s){
					s.stop();
				}
			},
			pause: function(s){
				if (s){
					s.pause();
				}
			},
			setVolume: function(s, vol){
				
			},
			setPosition: function(s, pos){
				
			},
			remove: function(s){
				if (s){
					s.destroySound();
				}
			},
			load: function(s){
				if (s){
					s.load();
				}
			},
			unload: function(id){
				
			}
		};
		
		

		(function(){
			if (location.hash && location.hash.length > 4){
				var opts_from_loc = getUrlParameters(  location.hash.replace('#', '')  );
			}
			var sm2opts = {
				flashVersion : 9,
				useFlashBlock : true,
				debugMode : false,
				wmode : 'opaque',
				useHighPerformance : true
			};
			if (opts_from_loc){
				cloneObj(  sm2opts, opts_from_loc  );
				
			}
			soundManager = new SoundManager('swf', false, sm2opts);
			soundManager.onready(function() {
				if (soundManager.supported()) {
					console.log('sm2 ok')
					sm2Loaded(soundManager);
				} else {
					sm2Loaded();
					console.log('sm2 notok')
			
				}
			});
		})();

	</script>
</head>
<!-- 16:16 -->
<body>

</body>
</html>
